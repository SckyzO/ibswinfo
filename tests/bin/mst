#!/usr/bin/env bash

DUMP_FILE="${MOCK_DUMP_FILE:-$(dirname "${BASH_SOURCE[0]}")/../mocks/ibsw_dump_4.33.0_MQM9790.txt}"

if [[ ! -f "$DUMP_FILE" ]]; then
    # Try to resolve relative path if executed from root
    if [[ -f "tests/mocks/$(basename "$DUMP_FILE")" ]]; then
         DUMP_FILE="tests/mocks/$(basename "$DUMP_FILE")"
    else
         echo "ERROR: Dump file not found: $DUMP_FILE" >&2
         exit 1
    fi
fi

# Mock for mst
if [[ "$1" == "version" ]]; then
    # Version extracted from dump (searching for "mst, mft")
    grep -A 5 "COMMAND: mst version" "$DUMP_FILE" | grep "mst, mft"
    exit 0
fi

if [[ "$1" == "status" ]]; then
    echo "MST modules:"
    echo "------------"
    echo "    MST PCI module loaded"
    echo "    MST PCI configuration module loaded"
    echo ""
    echo "MST devices:"
    echo "------------"
    # Device extracted from dump (searching for mlxreg_ext command)
    # Extract the device path from the first mlxreg_ext command found
    awk '/COMMAND: mlxreg_ext/ {for(i=1;i<=NF;i++) if($i=="-d") print $(i+1); exit}' "$DUMP_FILE"
    exit 0
fi
